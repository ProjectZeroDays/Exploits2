/*
** gma-click.c -- Standard 'click' version -- By GMA -- c5.hakker.com
**
** This program doesn't really do anything special.  I just saw certain
** 'pr0n clickers' out there and thought they could be improved in a
** couple of ways, so put this together.
**
**     1) Delay for a random period.
**     2) Connect to web server through wingate.
**     3) Provide the web server with various headers from the alleged
**        client including random "User-Agent" values and "Referer" values.
**     4) Download relevant images aswell as html to make the connection
**        look legit.
**
** Before you run this you have to add lines like the one on line 104 for
** each piece of html/gif/jpeg you want to download.  Read the code and
** figure it all out, then change what you want changing.
**
** (NB: Use only hostnames in the wingate file.)
** BUGS: For some reason won't work against some httpd's, but is fine
**       for the majority.
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#include <unistd.h>

#include <errno.h>
#include <netdb.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>

#define LOWDELAY 30
#define HIGHDELAY 300

static char *user_agent[] = {
        "Mozilla/4.0 (compatible; MSIE 4.0; Windows NT)",
        "Mozilla/4.03 [en] (Win95; I)",
        "Mozilla/4.0 (compatible; MSIE 4.0; Windows 95)",
        "Mozilla/2.0 (compatible; MSIE 3.02; Windows 95)",
        "Mozilla/4.04 [en]C-NECCK  (Win95; I)",
        "Mozilla/4.0 (compatible; MSIE 4.0; Windows 98)",
        "Mozilla/4.04 [en]C-NECCK  (Win98; I)",
        "Mozilla/3.03Gold (Win95; I)",
        "Mozilla/2.0 (compatible; MSIE 3.01; Windows 95)"
};

int rand0m(min, max)
int min;
int max;
{
    srand(time(NULL) * rand());
    return(min + (max-min+1) * (rand()/(RAND_MAX+1.0)));
}

int notegate(wingate)
char *wingate;
{
    FILE *lastgate;
    
    if ((lastgate = fopen("lastgate", "w")) == NULL)
    {
        printf("Unable to open lastgate file for writing!\n");
        exit(0);
    }
    
    fputs(wingate, lastgate);
    fclose(lastgate);
}
    
int doit(wgatefile)
char *wgatefile;
{
    FILE *list;

    int agent, delay, i=0;
    char wingate[128];
    
    if ((list = fopen(wgatefile, "r")) == NULL)
    {
        printf("Unable to open wingate list file for reading!\n");
        exit(0);
    }
    
    while(fgets(wingate, 80, list) != NULL) { i++; }
    rewind(list);
    printf("%i wingates in current list.\n", i);
    
    while(fgets(wingate, 80, list) != NULL)
    {
        agent = rand0m(0, 8);
        delay = rand0m(LOWDELAY, HIGHDELAY);

        printf("Using a delay of %i seconds.\n", delay);
        sleep(delay);
        
        *(strchr(wingate, '\n')) = '\0';
        printf("Current wingate: %s\n", wingate);
        notegate(wingate);
        
        ///////////                                                  ///////
        // Add lines like below for each html/image you want to download. //
        ///////                                                  ///////////
        if ((getfile(wingate, "server.com", "/directory/file.html", "none", user_agent[agent])) == -2) { printf("Using next wingate.\n"); break; }
    }
    fclose(list);
    return(0);
}

int getfile(wingate, webserv, file, referer, agent)
char *wingate;
char *webserv;
char *file;
char *referer;
char *agent;
{
    FILE *fd;

    int sock, i=1;
    struct hostent     *he;
    struct sockaddr_in sin;
    
    char outbound[1024], inbound[100];
    
    if ((sock = socket(AF_INET, SOCK_STREAM, 0)) == -1) { perror("socket"); return(-1); }
    if ((he = gethostbyname(wingate)) == NULL) { herror("gethostbyname"); return(-1); }
    
    sin.sin_family = AF_INET;
    sin.sin_port = htons(0);
    sin.sin_addr.s_addr = INADDR_ANY;

    bind(sock, (struct sockaddr *)&sin, sizeof(sin));
	    
    sin.sin_port = htons(23);
    memcpy(&sin.sin_addr, he->h_addr, he->h_length);

    if ((connect(sock, (struct sockaddr *)&sin, sizeof(sin))) == -1) { perror("connect"); exit(-1); }
    
    printf("Connection to %s established.\n", wingate);
    snprintf(outbound, sizeof(outbound), "%s 80\n", webserv);
    
    while((strstr(inbound, "WinGate>")) == NULL)
    {
        bzero(inbound, sizeof(inbound));
        read(sock, inbound, sizeof(inbound));
    }
    printf("Sending commands.\n");
    write(sock, outbound, strlen(outbound));

    while((strstr(inbound, "Connected")) == NULL)
    {
        if ((strstr(inbound, "Too many")) != NULL)
        {
            printf("Too many connected users on %s.\n", wingate);
            return(-2);
        }
        bzero(inbound, sizeof(inbound));
        read(sock, inbound, sizeof(inbound));
    }
    printf("Connection established through %s to %s.\n", wingate, webserv);
    
    if (referer == "none")
    {
        snprintf(outbound, 1024, "GET %s HTTP/1.0\n\nUser-Agent: %s\nHost: %s\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, image/png, */*\nAccept-Language: en-us\nAccept-Encoding: gzip, deflate\nAccept-Charset: iso-8859-1,*,utf-8\n",
                            file, agent, webserv);
    }
    else
    {
        snprintf(outbound, 1024, "GET %s HTTP/1.0\n\nUser-Agent: %s\nHost: %s\nReferer: %s\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, image/png, */*\nAccept-Language: en-us\nAccept-Encoding: gzip, deflate\nAccept-Charset: iso-8859-1,*,utf-8\n",
                            file, agent, webserv, referer);
    }
    write(sock, outbound, strlen(outbound));
    fflush(0);
    
    if ((fd = fopen("temp.file", "w")) == NULL)
    {
        printf("Unable to open temporary file for output!\n");
        exit(0);
    }
    
    while(i)
    {
        if ((read(sock, inbound, sizeof(inbound))) == 0)
        {
            i--;
        }
        read(sock, inbound, sizeof(inbound));
        fprintf(fd, "%s", inbound);
        if ((strstr(inbound, "</HTML>")) == NULL)
        {
            bzero(inbound, sizeof(inbound));
        }
        else i--;
    }

    fclose(fd);
    printf("Download of %s complete.\n", file);
    close(sock);
}

int main(argc, argv)
int argc;
char *argv[];
{
    if (argc < 2)
    {
        fprintf(stderr, "Usage: %s <wingate-file>\n", argv[0]);
        exit(0);
    }
    
    if ((doit(argv[1])) == 0) { printf("No more wingates in list.\n"); exit(0); }
}
