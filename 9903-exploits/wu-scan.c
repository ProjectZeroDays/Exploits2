/* This is probably more script-kiddie-ish than the last wu-ftpd scanner,
   but with almost no modifications you can make Lord Somer's IMAPVuln
   into a scanner that will look for anything, probably no point in
   putting it on the page, I'm sure someone will code one from scratch. 
   - SellOut 
*/
/* 
  IMAPVuln Scanner
  By: Lord Somer <webmaster@lordsomer.com>
  
  Scans the ips in a file to see if they run a vulnerable version of imap then output to a file
  Checks if ver is 9.0, 10.166, 10.171, 10.183, 10.190, 10.205, 10.223, 10.233
  Thanks to guy who made statd scanner, warchld for some of the other vulnerable version #'s.
*/
#include <sys/types.h>
#include <sys/socket.h>
#include <stdio.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <time.h>
#include <netdb.h>
#include <string.h>
#include <signal.h>
#include <unistd.h>

/*
  connect_timeo taken from mscan by jsbach
 */
#define TIMEOUT 5
#include <errno.h>
#include <stdlib.h>
#ifdef LINUX
#include <sys/time.h>
#endif
typedef void Sigfunc (int);

void connect_alarm(int signo);

int connect_timeo(int sockfd, struct sockaddr *saptr, int salen, int nsec) {
 int n;
 alarm(0);
 signal(SIGALRM,connect_alarm);
 alarm(TIMEOUT);

 if( (n = connect(sockfd, (struct sockaddr *) saptr, salen)) < 0) {
  close(sockfd);
  if(errno == EINTR)
  errno = ETIMEDOUT;
 }
 alarm(0);
 signal(SIGALRM, SIG_DFL);
 return(n);
}

void connect_alarm(int signo) {
 return;
}
/* end jsbach's code */

void usage(char *s) {
 printf("Original Usage");
 printf("IMAPVuln Scanner v1.0\n");
 printf("Usage: %s <inputfile> <outputfile>\n",s);
 printf(" By: Lord Somer <webmaster@lordsomer.com>\n");
 printf(" Check out efnet #sploits and\nThe Hackers Layer http://www.lordsomer.com\n");
 printf("This is modified to scan for, probably, exploitable wu-ftpds, same syntax.\n");
 exit(-1);
}

unsigned long int res(char *p)
{
   struct hostent *h;
   unsigned long int rv;
    
   h=gethostbyname(p);
   if(h!=NULL)
     memcpy(&rv,h->h_addr,h->h_length);
   else
     rv=inet_addr(p);
   return rv;
}

void imapscan(char *i, char *o) {
 FILE *iff, *of;
 char buf[512];
 if((iff=fopen(i,"r")) == NULL)
  return;
 while(fgets(buf,512,iff) != NULL) {
  if(buf[strlen(buf)-1]=='\n')
   buf[strlen(buf)-1]=0;
  if(imapvuln(buf) == 1 && (of=fopen(o,"a")) != NULL) {
   buf[strlen(buf)+1]=0;
   buf[strlen(buf)]='\n';
   fputs(buf,of);
   fclose(of);
  }  
 }
 fclose(iff);
}
int imapvuln(char *host) {
 int sockfd;
 int len;
 struct sockaddr_in address;
 int result;
 char buffer[200];

 sockfd = socket(AF_INET, SOCK_STREAM, 0);

 address.sin_family = AF_INET;
 address.sin_addr.s_addr = res(host);
 address.sin_port = htons(21);

 len = sizeof(address);
 if (connect_timeo(sockfd, (struct sockaddr *)&address, len, 2) == -1) {
  /* Host timed out, thus not vulnerable */
  close(sockfd);
  return 0;
 }
 result = read(sockfd, buffer, sizeof(buffer));

 /*
  *  We look for all versions that we know are vulnerable, i did it this way so it's easy to add
  * in new versions that an exploit comes out for.
  */
/* This is the only part I had to change, except for the port. 
   I based what it looks for on the comments by Gregory A Lundberg on
   BugTraq, we could get very specific here, but for times sake I don't
   think we need to. - SellOut 
*/
 if (strstr(buffer,"Version wu-2.4.2-academ[BETA-1")); 
 {
  close(sockfd);
  return 1;
 }
 close(sockfd);
 return 0;
}
int main(int argc, char **argv) {
 if (argc < 3)
  usage(argv[0]);
 imapscan(argv[1], argv[2]);
 return 1;
}
